---
layout: post
title:  "TAMU CTF 2021"
date:   2021-04-25
categories: writeups

---

# Foreword

I was going to have exams right after this CTF but what are exams man? (no idea, still stoning in class and at home). So anyways I played with HATS SG and we got 4th place (woo hooo!!).  Also its been a long time since I last did a writeup and I kinda missed doing writeups so maybe we'll have more writeups in the future? Who knows, and anyways exams are slowly becoming a reality for me.... 

Anyways I solved a few challenges but felt that this was the most fun and interesting challenge, thus the writeup. The other challenges I solved have >80 solves so I'm sure you can find the writeups somewhere on the internet. 

# Volatilie personality

* 500 Points, 7 solves
* We successfully exploited a target, but the IDS detected us! The only thing we got was this memory snapshot; think you can extract the flag from it?
* [mem.lime.zz](http://tamuctf.com/static-files/mem.lime.zz) (not sure how long it will stay up tho...)

This challenge is simply a pain and one of the harder memory dump challenges I've encountered. Kudos to the challenge author for making a very nice and interesting challenge albeit painful to solve. Got 3rd blood tho... (is that even a thing?) 

### Part 0

Evidently extracting out the mem-dump took 1h due to my failure to recognise it was zlib compressed. Heres the command to unzip it for those who are trying this challenge. 

`pigz -d mem.lime.zz`

### Part 1 (getting the profile)

Ah shit, here we go again...

* Realise its a linux memory dump and we need to make a volatility profile from scratch

  * Its LIME --> Its Linux

* Grep the kernel and linux distro/version. `GNU/Linux 5.4.0-42-generic x86_64` `Ubuntu 20.04.1`

  * ```
    root@ubuntu:/home/sean/Desktop# grep -a "Linux version" mem.lime 
    
    (truncated)
    
    Aug 27 02:53:33 redman-dev kernel: [    0.000000] Linux version 5.4.0-42-generic (buildd@lgw01-amd64-038) (gcc version 9.3.0 (Ubuntu 9.3.0-10ubuntu2)) #46-Ubuntu SMP Fri Jul 10 00:24:02 UTC 2020 (Ubuntu 5.4.0-42.46-generic 5.4.44)
    
    root@ubuntu:/home/sean/Desktop# grep -a "Linux 5.4.0-42-generic x86_64" mem.lime 
    
    (truncated)
    
    Welcome to Ubuntu 20.04.1 LTS (GNU/Linux 5.4.0-42-generic x86_64)
    ```

* Make a VM similar to the machine in the mem-dump. [ISO used](http://old-releases.ubuntu.com/releases/20.04.1/ubuntu-20.04.1-desktop-amd64.iso) 

  * The download was really slow, try using the torrent instead.

* Use volatility's tool to extract `module.dwarf` and then zip it together with `/boot/System.map-5.4.0-42-generic` to get the profile

  * ```bash
    git clone https://github.com/volatilityfoundation/volatility.git
    cd volatility/tools/linux
    make
    zip Volatility-Profile module.dwarf /boot/System.map-5.4.0-42-generic
    ```

Yep and after 1h of downloading and 30 min of running linux commands we get a Volatility Profile.

### Part 2 (funny volatility stuff)

Once again, its time to see what funny things the challenge author did. We should be looking out for some sort of a rootkit or malware etc since the challenge description hints at `exploiting a target`. So after triaging our memory dump (bash history, processes), we find that this is a very clean memory dump with not much going on.

Bash History:

```
Pid      Name                 Command Time                   Command
-------- -------------------- ------------------------------ -------
    1903 bash                 2020-08-27 02:56:11 UTC+0000   cd git/
    1903 bash                 2020-08-27 02:56:11 UTC+0000   ls
    1903 bash                 2020-08-27 02:56:11 UTC+0000   cd something-special/
    1903 bash                 2020-08-27 02:56:11 UTC+0000   cd linux-kernel-module-rust/
    1903 bash                 2020-08-27 02:56:11 UTC+0000   ls
    1903 bash                 2020-08-27 02:56:11 UTC+0000   ls
    1903 bash                 2020-08-27 02:56:11 UTC+0000   sudo insmod somethingspecial.ko 
    1903 bash                 2020-08-27 02:56:11 UTC+0000   ls
    1903 bash                 2020-08-27 02:56:17 UTC+0000   cd $(mktemp -d)
    1903 bash                 2020-08-27 02:56:40 UTC+0000   git clone https://github.com/504ensicsLabs/LiME.git
    1903 bash                 2020-08-27 02:56:45 UTC+0000   cd LiME/src/
    1903 bash                 2020-08-27 02:56:45 UTC+0000   ls
    1903 bash                 2020-08-27 02:56:46 UTC+0000   make
    1903 bash                 2020-08-27 02:56:51 UTC+0000   ls
    1903 bash                 2020-08-27 02:58:43 UTC+0000   sudo insmod lime-5.4.0-42-generic.ko "path=tcp:4444 compress=1 format=lime"
```

Processes:

```
Name                 Pid             Uid            
systemd              1                              
.systemd-journal     448                            
.systemd-udevd       478                            
.multipathd          625                            
.systemd-timesyn     673             102            
.systemd-network     700             100            
.systemd-resolve     702             101            
.accounts-daemon     716                            
.cron                722                            
.dbus-daemon         724             103            
.irqbalance          733                            
.networkd-dispat     734                            
.rsyslogd            735             104            
.systemd-logind      740                            
.atd                 746                            
.sshd                751                            
..sshd               1810                           
...sshd              1902            1000           
....bash             1903            1000           
.....sudo            2472                           
......insmod         2474                           
(truncated)
```

(FYI, the lime kernel module is needed to extract the memory dump using LIME) 

But wait, why did he insert the `somethingspecial.ko` kernel module. Seems suspicious..... If u were to do some OSINT, you would find that `linux-kernel-module-rust` is a GitHub repository but does not contain `somethingspecial.ko`, suggesting that this is something written by the authors. Now this could also suggest that `somethingspecial.ko` is the exploit used against the machine which should be our flag...

Now I had to ensure that I was not tunnel visioning as it was nearly 2am in the morning or something. So I did a few checks to make sure I wasn't stoning and this was the way to proceed

Enumerate Files:

```
Path
----
(truncated)

/home/redman/git
/home/redman/git/linux-kernel-module-rust
/home/redman/git/linux-kernel-module-rust/tests
/home/redman/git/linux-kernel-module-rust/CONTRIBUTING.md
/home/redman/git/linux-kernel-module-rust/target
/home/redman/git/linux-kernel-module-rust/something-special/somethingspecial.mod
/home/redman/git/linux-kernel-module-rust/something-special/something_special.rust.o
/home/redman/git/linux-kernel-module-rust/something-special/target

(truncated)

/home/redman/git/linux-kernel-module-rust/something-special/somethingspecial.ko
```

Once again, this confirms our suspicion that `somethingspecial.ko` is something made by the challenge author and is in fact recoverable... Seems like we may need to do some reverse engineering...

Listing loaded kernel modules:

```
ffffffffc0a2a040 lime 24576
	compress=1                                                                                          
	timeout=1000                                                                                        
	digest=(null)                                                                                       
	localhostonly=0                                                                                     
	format=lime                                                                                         
	dio=0                                                                                               
	path=tcp:4444                                                                                       
ffffffffc0974040 somethingspecial 1892352

(truncated)
```

Things to note, `somethingspecial`was not loaded with any parameters (this may help in the RE process later on). Additionally, its the odd one out (i.e the rest of the modules are normal). 

Checking the dmesg output with volatility yields the following interesting output:

```
[152841957826.152] somethingspecial: loading out-of-tree module taints kernel.
[152841964049.152] somethingspecial: module license 'WTFPL' taints kernel.
[152841965252.152] Disabling lock debugging due to kernel taint
[152846153458.152] somethingspecial: module verification failed: signature and/or required key missing - tainting kernel
[152863341210.152] Ah, now you won't forget! :)
```

"Ah now you won't forget" is printed by the kernel module and should aid in the RE process. At this point, we can also confirm that `somethingspecial.ko` is the module we need to reverse and the path to our flag. 

### Part 3 (Reverse Engineering)

After dumping the module, I realised two things. First, it's a 18mb rust binary. Second, this is way above my paygrade and its impossible for me to RE this without help. Thankfully, my 大老板 (big boss) [Daniao](https://daniao.ws/) came to help me. What followed was 1h of waiting for Ghidra and 10 minutes of looking around.

![img](https://i.imgur.com/MhmgQzh.png)

**"I saw a bitxor and 2 interesting labels" -- Daniao, 2021**

(The author at this moment was trying to figure out how IDA didnt show him the bitxor and decided to try ghidra, something he hasnt used in the longest time. After catching up to where Daniao found the bitxor, the author finally managed to partially understand some ASM and the following is some screenshots of the 2 interesting labels and the call to bitxor)

Note: This bitxor and 2 interesting labels were found at  **something special read function**

![img](https://i.imgur.com/sOFi2aH.jpg)

(Interesting Label 1)

![img](https://i.imgur.com/RfoLfIr.jpg)

(Interesting Label 2)

![img](https://i.imgur.com/YmgkNp1.jpg)

(Call to bitxor)

The last step is to of course xor the interesting labels and obtain the flag which Daniao did.

```python
>>> a = "a082d607fb9edbccaf4d4fef33b94c7ff7483d0a0bb6f3bbd42c26d0"
>>> b = "c7ebb16296e5a9a9cb202e816cd12d0ca82a5c6e54db96d6bb5e5fad"
>>> from pwn import xor
>>> xor(a.decode("hex"), b.decode("hex"))
'gigem{redman_has_bad_memory}'
```

### Alternative method??

As with all things, there is always another way of solving it. Which in this case is some "dynamic analysis" or rather replication of what the author did (presumably to check that the flag could be found)

Now the bash history may have been cleared but `strings` is here to save the day once again. :)

```
(truncated)

cd something-special/
nano src/lib.rs 
dmesg
sudo rmmod somethingspecial 
dmesg
cat /proc/devices 
make
nano src/lib.rs 
make
nano src/lib.rs 
make
sudo insmod somethingspecial.ko 
dmesg
cat /proc/devices 
mknod -h
mknod --help
cd $(mktemp -d)
mknod special c 239 0
mknod somethingspecial c 239 0
```

Since we had to make a similar machine to extract the volatility profile, we can simply repeat the above commands in the VM we created to get the flag. 

Note: Although different Ubuntu versions may have produced a profile that would work, it is evident that finding the exact version is very important for this method of solving. 

Commands/Output

```
root@ubuntu:/home/test/Desktop# sudo insmod somethingspecial.ko 
root@ubuntu:/home/test/Desktop# cat /proc/devices 
Character devices:

(truncated)

240 something-special

Block devices:

(truncated)

root@ubuntu:/home/test/Desktop# mknod flag c 239 0
root@ubuntu:/home/test/Desktop# cat flag
gigem{redman_has_bad_memory}

(truncated repeated mess of the flag)
```

FYI, it was a character device driver. As such, we can make a special file to get the flag. 

### Flag

bruh in case you missed it, here it is. **`gigem{redman_has_bad_memory}`**

### Takeaways

* I need to git gud at RE.
* There's always multiple ways to solve a challenge (in this case static analysis and just loading the kernel module)
* Thanks [Daniao](https://daniao.ws/) for helping RE the module :)
